<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Explore Books</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: url(image/book.jpg) no-repeat center center fixed;
      background-size: cover;
      color: white;
    }

    .main {
      text-align: center;
      margin-top: 80px;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 3em;
      margin-bottom: 0.2em;
    }

    .quote {
      font-style: italic;
      font-size: 1.3em;
      margin-bottom: 2em;
    }

    .search-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .search-bar input {
      padding: 10px;
      width: 300px;
      border-radius: 5px;
      border: none;
    }

    .search-bar button {
      padding: 10px 20px;
      background-color: #0055aa;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .book {
      background-color: rgba(0,0,0,0.6);
      margin: 20px auto;
      padding: 15px;
      border-radius: 10px;
      color: white;
      width: 80%;
      max-width: 600px;
    }

    .book a {
  color: #00ccff;
  text-decoration: none;
  font-weight: bold;
}

.book a:hover {
  text-decoration: underline;
}


    .book img {
      max-width: 100px;
      float: left;
      margin-right: 15px;
    }

    .spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

  </style>
</head>
<body>

  <!--Welcome page -->
  <div class="main">
  <h1>BOOK FINDER</h1>
  <p id="welcomeUser"></p>
  <p class="quote">“Reading is to the mind what exercise is to the body.”</p>

  <!-- Search bar -->
  <div class="search-bar">
    <input type="text" placeholder="Enter book name..." id="searchInput">
  <!-- Sort section -->
    <select id="sort">
      <option value="">Sort: Default</option>
      <option value="date">Published Date</option>
      <option value="pages">Page Count</option>
    </select>
  <!-- Text inputs -->
    <input type="text" id="filter" placeholder="Filter by author...">

    <button onclick="searchBooks()">SEARCH</button>
  </div>
</div>

<!-- Link to Favorites Page -->
  <div class="favorites-link">
    <a href="favorite.html">View My Favorites</a>
  </div>

<div id="loading" style="display:none;">Loading...</div>
<div id="results"></div>

<script type="module">
    import { API_KEY } from './config.js';
  let books = [];

  async function searchBooks() {
    const query = document.getElementById('searchInput').value;
    const loading = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');

    // Show spinner
    loading.style.display = 'block';
    resultsDiv.innerHTML = '';

    try {
      const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&key=${API_KEY}`);
      const data = await res.json();

      if (!data.items || data.items.length === 0) {
      resultsDiv.innerHTML = "<p>No books found. Try another search.</p>";
      return; // stop here so renderBooks() is not called
    }

      books = data.items || [];
      renderBooks();
    } catch (error) {
      resultsDiv.innerHTML = "<p>Error No results. Please try again later.</p>";
      console.error(error);
    } finally {
      // Hide spinner
      loading.style.display = 'none';
    }
  }

  function renderBooks() {
    const sortOption = document.getElementById('sort').value;
    const filterText = document.getElementById('filter').value.toLowerCase();
    let results = [...books];

    // Filter by author
    if (filterText) {
      results = results.filter(book => {
        const authors = book.volumeInfo.authors?.join(', ').toLowerCase() || '';
        return authors.includes(filterText);
      });
    }

    // Sort
    if (sortOption === 'date') {
      results.sort((a, b) => new Date(b.volumeInfo.publishedDate) - new Date(a.volumeInfo.publishedDate));
    } else if (sortOption === 'pages') {
      results.sort((a, b) => (b.volumeInfo.pageCount || 0) - (a.volumeInfo.pageCount || 0));
    }

    // Render results
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = results.map(book => {
      const info = book.volumeInfo;
      return `
        <div class="book">
          <img src="${info.imageLinks?.thumbnail || ''}" alt="Cover">
          <h3>${info.title}</h3>
          <p><strong>Author:</strong> ${info.authors?.join(', ') || 'Unknown Author'}</p>
          <p><strong>Published:</strong> ${info.publishedDate || 'Unknown'}</p>
          <p><strong>Pages:</strong> ${info.pageCount || 'N/A'}</p>
          <p>${info.description?.slice(0, 200) || 'No description available.'}</p>
          <p><a href="${info.infoLink}" target="_blank">Read More</a></p>
          <p><button onclick="addToFavorites('${info.title}', '${info.authors?.join(', ')}', '${info.infoLink}')">⭐ Add to Favorites</button></p>
        </div>
      `;
    }).join('') || "<p>No books found. Try another search.</p>";
  }

  function addToFavorites(title, author, link) {
  const user = localStorage.getItem('bookFinderUser') || 'guest';
  const favoritesKey = `favorites_${user}`;
  const existing = JSON.parse(localStorage.getItem(favoritesKey)) || [];

  // Avoid duplicates
  if (existing.some(book => book.title === title)) {
    alert("Already in favorites.");
    return;
  }

  existing.push({ title, author, link });
  localStorage.setItem(favoritesKey, JSON.stringify(existing));
  alert("Book added to favorites!");
}

  // Auto-refresh results when sort/filter changes
  document.getElementById('sort').addEventListener('change', renderBooks);
  document.getElementById('filter').addEventListener('input', renderBooks);

  // Show welcome message
  const user = localStorage.getItem('bookFinderUser');
  document.getElementById('welcomeUser').innerText =
    user === 'guest' ? "Welcome, Guest" : `Welcome, ${user}`;


  // Auto-refresh results when sort/filter changes
  document.getElementById('sort').addEventListener('change', renderBooks);
  document.getElementById('filter').addEventListener('input', renderBooks);
</script>

</body>
</html>
